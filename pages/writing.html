<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Luy·ªán vi·∫øt Kanji</title>
    <link rel="stylesheet" href="../css/font.css">
    <script src="../data-kanji/data-n5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <style>
        body { 
            margin: 0; background: #f4f7f9; display: flex; flex-direction: column; 
            align-items: center; min-height: 100vh; font-family: 'Quicksand', sans-serif; padding: 20px;
        }

        /* N√∫t Tho√°t */
        .btn-exit {
            position: absolute; top: 20px; left: 20px;
            background: white; border: 1px solid #ddd; padding: 8px 15px;
            border-radius: 10px; text-decoration: none; color: #666;
            font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 5px;
            transition: all 0.2s; z-index: 100;
        }
        .btn-exit:hover { background: #fff0f0; color: #e74c3c; border-color: #fab1a0; }

        #char-han-title { font-size: 2.2rem; font-weight: 700; color: #2c3e50; margin-top: 40px; margin-bottom: 5px; }
        
        /* Thanh ti·∫øn tr√¨nh m·ªõi */
        .progress-wrapper {
            width: 100%; max-width: 320px; margin-bottom: 20px; text-align: center;
        }
        .progress-container {
            width: 100%; height: 12px; background: #e0e6ed; border-radius: 10px;
            overflow: hidden; margin-top: 8px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .progress-bar {
            width: 10%; height: 100%; background: linear-gradient(90deg, #edbb68, #f39c12);
            border-radius: 10px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .mode-label { font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

        .canvas-container { 
            position: relative; background: white; padding: 15px; border-radius: 30px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.08); 
        }
        #kanji-target { width: 320px; height: 320px; }
        
        .bottom-toolbar { margin-top: 30px; display: flex; gap: 15px; }
        .btn { padding: 12px 35px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-family: 'Quicksand'; transition: 0.3s; min-width: 140px; }
        .btn-clear { background: #fff; color: #555; border: 1px solid #ddd; }
        .btn-next { background: #edbb68; color: white; box-shadow: 0 4px 15px rgba(237, 187, 104, 0.4); }
        .btn-next:disabled { background: #d1d5db; color: #9ca3af; cursor: not-allowed; box-shadow: none; }
        
        .success-msg { color: #27ae60; font-weight: 700; opacity: 0; transition: 0.3s; margin-top: 15px; }
        .success-msg.show { opacity: 1; }
    </style>
</head>
<body>

    <a href="#" onclick="confirmExit()" class="btn-exit">‚úï Tho√°t</a>

    <div id="char-han-title">...</div>
    
    <div class="progress-wrapper">
        <div id="mode-text" class="mode-label">ƒêang hi·ªán m·∫´u</div>
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        <div style="font-size: 0.8rem; margin-top: 5px; color: #94a3b8; font-weight: 600;">
            Ti·∫øn ƒë·ªô: <span id="progress-text">1</span>/10
        </div>
    </div>

    <div class="canvas-container">
        <div id="kanji-target"></div>
    </div>

    <div id="finish-msg" class="success-msg">üéâ Xu·∫•t s·∫Øc! B·∫°n ƒë√£ thu·ªôc ch·ªØ n√†y.</div>

    <div class="bottom-toolbar">
        <button class="btn btn-clear" id="resetBtn">Vi·∫øt l·∫°i</button>
        <button class="btn btn-next" id="nextBtn" disabled>Ti·∫øp t·ª•c</button>
    </div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const char = urlParams.get('k') || 'Ê∞ó';
    let writeCount = 1;
    const maxWrites = 10;

    const nextBtn = document.getElementById('nextBtn');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const modeTextDisplay = document.getElementById('mode-text');

    if (typeof kanjiData !== 'undefined' && kanjiData[char]) {
        document.getElementById('char-han-title').innerText = kanjiData[char].h√°n;
    }

    function confirmExit() {
        if (writeCount < maxWrites && confirm("B·∫°n ch∆∞a ho√†n th√†nh luy·ªán t·∫≠p. B·∫°n c√≥ ch·∫Øc mu·ªën tho√°t kh√¥ng?")) {
            history.back();
        } else if (writeCount >= maxWrites) {
            history.back();
        }
    }

    const writer = HanziWriter.create('kanji-target', char, {
        width: 320, height: 320, padding: 25,
        strokeColor: '#2c3e50', drawingColor: '#edbb68', drawingWidth: 15,
        charDataLoader: function(char, onComplete) {
            fetch(`https://raw.githubusercontent.com/chanind/hanzi-writer-data-jp/master/data/${char}.json`)
                .then(res => res.ok ? res.json() : Promise.reject())
                .then(onComplete)
                .catch(() => {
                    fetch(`https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/${char}.json`)
                        .then(res => res.json()).then(onComplete);
                });
        }
    });

    function setupQuiz() {
        // C·∫≠p nh·∫≠t thanh ti·∫øn tr√¨nh
        const percentage = (writeCount / maxWrites) * 100;
        progressBar.style.width = percentage + "%";
        progressText.innerText = writeCount;
        
        nextBtn.disabled = true;
        
        if (writeCount <= 5) {
            modeTextDisplay.innerText = "Ch·∫ø ƒë·ªô: ƒê·ªì theo m·∫´u";
            modeTextDisplay.style.color = "#edbb68";
            writer.updateColor('outlineColor', '#f0f0f0');
            writer.showOutline();
        } else {
            modeTextDisplay.innerText = "Ch·∫ø ƒë·ªô: T·ª± nh·ªõ n√©t";
            modeTextDisplay.style.color = "#e74c3c";
            writer.hideOutline();
        }

        writer.quiz({
            onComplete: function() {
                nextBtn.disabled = false;
                if (writeCount === maxWrites) {
                    nextBtn.innerText = "Ho√†n th√†nh";
                    document.getElementById('finish-msg').classList.add('show');
                } else {
                    nextBtn.innerText = "Ti·∫øp t·ª•c";
                }
            }
        });
    }

    nextBtn.addEventListener('click', () => {
        if (writeCount < maxWrites) {
            writeCount++;
            setupQuiz();
        } else {
            history.back();
        }
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
        writer.quiz();
        nextBtn.disabled = true;
    });

    window.onload = setupQuiz;
</script>
</body>
</html>