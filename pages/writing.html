<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyện tập Kanji theo chu kỳ</title>
    <link rel="stylesheet" href="../css/font.css">
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <style>
        :root { --primary-orange: #f1b34c; --bg: #f8f9fa; }
        body { font-family: 'Quicksand', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .header { width: 100%; max-width: 500px; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        .back-btn { text-decoration: none; color: #888; font-weight: 700; font-size: 0.9rem; }
        .total-progress { background: var(--primary-orange); color: white; padding: 8px 18px; border-radius: 20px; font-weight: 800; font-size: 0.85rem; }

        .writing-card {
    background: white;
    border-radius: 20px;
    padding: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.05);
    margin-top: 20px;
    text-align: center;
    width: 100%;
    max-width: 400px;
    position: relative;
    box-sizing: border-box;
}
        
        .mode-tag { display: inline-block; padding: 6px 16px; border-radius: 12px; font-size: 0.75rem; font-weight: 800; margin-bottom: 12px; }
        .mode-see { background: #e3f2fd; color: #1976d2; } 
        .mode-remember { background: #fff3e0; color: #f57c00; } 

        #cycle-count { font-size: 1rem; font-weight: 700; color: #2c3e50; margin-bottom: 20px; }

        .step-dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 25px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #edf2f7; transition: 0.4s; }
        .dot.active { background: var(--primary-orange); transform: scale(1.4); }
        .dot.done { background: #2ecc71; }

        #target-svg { background: #fff; border-radius: 20px; cursor: crosshair; margin: 0 auto; }
        
        /* Nút Điều hướng */
        .nav-controls { margin-top: 25px; min-height: 50px; }
        .btn-nav { 
            display: none; /* Ẩn mặc định, chỉ hiện khi viết xong 1 lượt */
            border: none; 
            padding: 12px 40px; 
            border-radius: 15px; 
            font-family: 'Quicksand'; 
            font-weight: 700; 
            cursor: pointer; 
            font-size: 1rem;
            transition: 0.3s;
            width: 100%;
        }
        .btn-continue { background: var(--primary-orange); color: white; box-shadow: 0 4px 15px rgba(241, 179, 76, 0.3); }
        .btn-finish { background: #2ecc71; color: white; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3); }
        .btn-nav:hover { transform: translateY(-2px); opacity: 0.9; }

        #msg { margin-top: 15px; font-weight: 700; min-height: 24px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="header">
        <a href="javascript:history.back()" class="back-btn">← Thoát</a>
        <div id="total-percent" class="total-progress">Tổng tiến độ: 0%</div>
    </div>

    <div class="writing-card">
        <div id="mode-label" class="mode-tag mode-see">GIAI ĐOẠN: NHÌN MẪU</div>
        <div id="cycle-count">Lượt viết: 1 / 10</div>

        <div class="step-dots" id="step-dots"></div>
        <div id="target-svg"></div>
        
        <div id="msg"></div>

        <div class="nav-controls">
            <button id="btn-continue" class="btn-nav btn-continue" onclick="nextStep()">Tiếp tục</button>
            <button id="btn-finish" class="btn-nav btn-finish" onclick="finishSession()">Xong</button>
        </div>
    </div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const char = urlParams.get('k') || '日';
    let currentStep = 1; 
    let writer;

    function init() {
        const dotsContainer = document.getElementById('step-dots');
        for (let i = 1; i <= 10; i++) {
            const dot = document.createElement('div');
            dot.className = 'dot';
            dot.id = `dot-${i}`;
            dotsContainer.appendChild(dot);
        }

        writer = HanziWriter.create('target-svg', char, {
            width: 280, height: 280, padding: 30,
            showOutline: true,
            strokeColor: '#2c3e50',
            drawingColor: '#f1b34c',
            drawingWidth: 20,
            showCharacter: false
        });

        updateUI();
        startQuizMode();
    }

    function startQuizMode() {
        const isMemoryMode = currentStep > 5;
        writer.updateColor('outlineColor', isMemoryMode ? '#ffffff' : '#f3f3f3');
        
        // Ẩn các nút điều hướng khi bắt đầu lượt viết mới
        document.getElementById('btn-continue').style.display = 'none';
        document.getElementById('btn-finish').style.display = 'none';

        writer.quiz({
            onComplete: function(summary) {
                handleStepComplete();
            }
        });
    }

    function handleStepComplete() {
        document.getElementById(`dot-${currentStep}`).classList.add('done');
        const msg = document.getElementById('msg');
        
        if (currentStep < 10) {
            msg.innerHTML = "<span style='color: #2ecc71;'>Chính xác! Bấm tiếp tục để sang lượt mới.</span>";
            document.getElementById('btn-continue').style.display = 'block';
        } else {
            msg.innerHTML = "<span style='color: #2ecc71;'>Hoàn thành chu kỳ! Bấm Xong để lưu tiến độ.</span>";
            document.getElementById('btn-finish').style.display = 'block';
        }
    }

    function nextStep() {
        currentStep++;
        document.getElementById('msg').innerText = "";
        updateUI();
        startQuizMode();
    }

    function finishSession() {
        saveTotalProgress();
        // Quay lại trang trước đó (detail.html hoặc n5.html)
        history.back();
    }

    function saveTotalProgress() {
        let totalCount = parseInt(localStorage.getItem(`count_${char}`) || 0);
        if (totalCount < 5) {
            totalCount++;
            localStorage.setItem(`count_${char}`, totalCount);
        }
    }

    function updateUI() {
        document.getElementById('cycle-count').innerText = `Lượt viết: ${currentStep} / 10`;
        const modeLabel = document.getElementById('mode-label');
        
        if (currentStep <= 5) {
            modeLabel.innerText = "GIAI ĐOẠN: NHÌN MẪU";
            modeLabel.className = "mode-tag mode-see";
        } else {
            modeLabel.innerText = "GIAI ĐOẠN: NHỚ CHỮ";
            modeLabel.className = "mode-tag mode-remember";
        }

        document.querySelectorAll('.dot').forEach(d => d.classList.remove('active'));
        const activeDot = document.getElementById(`dot-${currentStep}`);
        if(activeDot) activeDot.classList.add('active');

        const totalCount = parseInt(localStorage.getItem(`count_${char}`) || 0);
        document.getElementById('total-percent').innerText = `Tổng tiến độ: ${totalCount * 20}%`;
    }

    window.onload = init;
</script>
</body>
</html>